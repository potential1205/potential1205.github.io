{{- $mainSections := site.Params.mainSections | default (slice "posts") -}}
{{- $allPages := where site.RegularPages "Section" "in" $mainSections -}}
{{- $categoriesMap := site.Taxonomies.categories -}}
{{- if or (gt (len $categoriesMap) 0) (gt (len $allPages) 0) -}}
  {{- $sectionPage := site.Home -}}
  {{- if gt (len $mainSections) 0 -}}
    {{- $section := index $mainSections 0 -}}
    {{- with site.GetPage (printf "/%s" $section) -}}
      {{- $sectionPage = . -}}
    {{- end -}}
  {{- end -}}
  {{- $ctx := . -}}
  {{- $termLower := "" -}}
  {{- if eq $ctx.Kind "term" -}}
    {{- with $ctx.Data.Term -}}
      {{- $termLower = lower (printf "%v" .) -}}
    {{- else -}}
      {{- $termLower = lower $ctx.Title -}}
    {{- end -}}
  {{- end -}}
  {{- $pageCategories := slice -}}
  {{- if (and $ctx.IsPage $ctx.Params.categories) -}}
    {{- range $idx, $cat := $ctx.Params.categories -}}
      {{- $pageCategories = $pageCategories | append (lower (printf "%v" $cat)) -}}
    {{- end -}}
  {{- end -}}
  {{- $categories := slice -}}
  {{- range $name, $pages := $categoriesMap -}}
    {{- $categories = $categories | append (dict "name" $name "pages" $pages) -}}
  {{- end -}}
  <nav class="category-nav" aria-label="카테고리">
    <ul class="category-nav__list">
      {{- $allActive := and (eq $ctx.Kind "section") (in $mainSections $ctx.Section) -}}
      <li class="category-nav__item{{ if $allActive }} is-active{{ end }}" data-category="__all">
        <a class="category-nav__link" href="{{ $sectionPage.RelPermalink }}"{{ if $allActive }} aria-current="page"{{ end }}>
          <span class="category-nav__name">전체보기</span>
          <span class="category-nav__count">{{ len $allPages }}</span>
        </a>
      </li>
      {{- range sort $categories "name" -}}
        {{- $name := .name -}}
        {{- $pages := .pages -}}
        {{- $nameStr := printf "%v" $name -}}
        {{- $slug := urlize $nameStr -}}
        {{- $nameLower := lower $nameStr -}}
        {{- $termPage := site.GetPage (printf "/categories/%s" $slug) -}}
        {{- $displayName := cond $termPage $termPage.Title $nameStr -}}
        {{/* Active when viewing the category list or a post that belongs to this category */}}
        {{- $isActive := or (and (ne $termLower "") (eq $termLower $nameLower)) (and (eq $ctx.Kind "section") (eq (lower (printf "%v" $ctx.Title)) $nameLower)) -}}
        <li class="category-nav__item{{ if $isActive }} is-active{{ end }}" data-category="{{ $nameLower }}">
          <a class="category-nav__link" href="{{ relLangURL (printf "categories/%s/" $slug) }}"{{ if $isActive }} aria-current="page"{{ end }}>
            <span class="category-nav__name">{{ $displayName }}</span>
            <span class="category-nav__count">{{ len $pages }}</span>
          </a>
        </li>
      {{- end -}}
    </ul>
    {{- if and $ctx.IsPage (not $ctx.IsSection) -}}
    <script>
      (function() {
        try {
          var ref = document.referrer;
          if (!ref) return;
          var refUrl = new URL(ref);
          if (!refUrl.pathname.includes('/categories/')) return;
          var match = refUrl.pathname.match(/\/categories\/([^\/]+)/);
          if (!match || !match[1]) return;
          var slug = decodeURIComponent(match[1]);
          var items = document.querySelectorAll('.category-nav__item');
          if (!items.length) return;
          var target = null;
          items.forEach(function(item) {
            if (item.dataset.category === slug) {
              target = item;
            }
          });
          if (!target) return;
          items.forEach(function(item) {
            item.classList.remove('is-active');
            var link = item.querySelector('a');
            if (link) link.removeAttribute('aria-current');
          });
          target.classList.add('is-active');
          var link = target.querySelector('a');
          if (link) link.setAttribute('aria-current', 'page');
        } catch (err) {
          console.warn('category highlight script error', err);
        }
      })();
    </script>
    {{- end -}}
  </nav>
{{- end -}}
